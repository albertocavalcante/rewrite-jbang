# OpenRewrite as a jbang script

As an experiment from asking https://github.com/openrewrite/rewrite/discussions/834
I made this little script which is based on the code found in https://github.com/openrewrite/rewrite-maven-plugin.

It lets you run OpenRewrite on any kind of project. The script is now compatible with OpenRewrite v8.49.0.

How to run: 

1. Install `jbang` (https://jbang.dev/download)
2. You can list recipes using:

[source,sh]
----
jbang rewrite.java discover
----

3. Try running it with a few recipes: 

[source,sh]
----
jbang rewrite.java --recipes org.openrewrite.java.format.AutoFormat
----

You can also install the script locally using: `jbang app install rewrite.java`
and just use `rewrite` directly, i.e.:

[source,sh]
----
rewrite --recipes org.openrewrite.java.format.AutoFormat --dry-run
----

=== Using JBang Catalog

This repository includes a `jbang-catalog.json` that defines several useful aliases:

[source,sh]
----
# Add the catalog
jbang catalog add --name rewrite https://github.com/openrewrite/rewrite-jbang

# List available aliases
jbang alias list rewrite

# Use recipe-specific aliases
jbang format        # Run AutoFormat recipe
jbang cleanup       # Run Cleanup recipe
jbang unused-imports # Remove unused imports
jbang sort-dependencies # Sort Maven dependencies
----

You can also use the script directly via the catalog without adding it:

[source,sh]
----
jbang format@maxandersen/rewrite-jbang
----

Usage tips: 

* Use `--dry-run` to see proposed changes and generate a patch file (default: `./rewrite/rewrite.patch`).
* When running without `--dry-run`, changes will be applied directly to your files.
* Always review changes before committing them to version control.

== Requirements

* Java 21 or higher is required to run this script.
* JBang will automatically download the required Java version if necessary.

== Key Options

`--recipes <list>`::
Comma-separated list of fully qualified recipe names to activate. Example: `org.openrewrite.java.format.AutoFormat`

`--styles <list>`::
Comma-separated list of style configuration names to activate.

`--base-dir <path>`::
Base directory for the project. All paths are resolved relative to this directory. Defaults to the current directory.

`--javaSources <list>`::
Comma-separated list of directories containing Java source files to scan. Defaults to `.`

`--discover-resources <boolean>`::
Attempt to discover resource files (`.yml`, `.yaml`, `.properties`, `.xml`, `.toml`) within the `--javaSources` directories. Defaults to `true`. Set to `false` to disable scanning for these files.

`--classpath <string>`::
Specify the classpath needed for type resolution in Java recipes. Use the system's path separator (e.g., `:` for Linux/macOS, `;` for Windows). Example: `--classpath "lib/dep1.jar:target/classes"`. Crucial for recipes that need to understand types from dependencies.

`--dry-run <boolean>`::
If `true`, lists changes and outputs a patch file instead of modifying files.

`--fail-on-dry-run <boolean>`::
If `true` and `--dry-run` is active, the script will exit with an error code if any changes are detected. Defaults to `false`.

`--report <path>`::
Directory where the `rewrite.patch` file is written during a dry run. Defaults to `./rewrite`.

== Common Recipe Examples

OpenRewrite provides many useful recipes. Here are some examples:

[source,sh]
----
# Format Java code
jbang rewrite.java --recipes org.openrewrite.java.format.AutoFormat

# Remove unused imports
jbang rewrite.java --recipes org.openrewrite.java.RemoveUnusedImports

# Modernize Java
jbang rewrite.java --recipes org.openrewrite.java.cleanup.Cleanup

# Maven: Sort dependencies
jbang rewrite.java --recipes org.openrewrite.maven.SortDependencies

# Maven: Update a dependency version
jbang rewrite.java --recipes org.openrewrite.maven.ChangeDependencyVersion \
  --groupId com.google.guava --artifactId guava --newVersion 31.1-jre
----

For a complete list of available recipes, run:
[source,sh]
----
jbang rewrite.java discover
----

== Limitations

* Does not automatically resolve dependencies from build files (use `--classpath` for manual provision).
* Limited type resolution without an explicit classpath.
* Some recipes may require additional configuration parameters.

== Development Notes

* Uses JBang for execution and dependency management.
* Dependencies are declared via `//DEPS` comments in `rewrite.java`.
* Current version is compatible with OpenRewrite v8.49.0.
* For upgrade workflow details, see `rules.md` in this repository.

== Troubleshooting

=== No Changes Applied

If the recipe doesn't apply changes:

* Verify you're NOT using `--dry-run` if you want to actually apply changes
* Check if the recipe produced any errors in the output
* Ensure the recipe is applicable to your codebase (some recipes are language or framework-specific)

=== Classpath Issues

For type resolution problems:

* Provide the classpath with all necessary dependencies
* For Maven projects: `mvn dependency:build-classpath -Dmdep.outputFile=cp.txt`
* For Gradle projects: `gradle -q printClasspath > cp.txt`
* Then use the generated classpath: `jbang rewrite.java --classpath "$(cat cp.txt)" --recipes ...`

=== Java Version Compatibility

* Ensure your JDK version is compatible with the project you're modifying
* The JBang script requires Java 21 or later